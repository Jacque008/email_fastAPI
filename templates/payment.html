<!DOCTYPE html>
<html >

<head>
  <meta charset="UTF-8">
  <title>Betalningsmatchning</title>
  <link href='https://fonts.googleapis.com/css?family=Pacifico' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Arimo' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Hind:300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/static/css/style.css"> 
  
</head>

<body>
    <div class="ban">
      <h3>{{ title or "Betalningsmatchning" }}</h3>
      <form class="float-title" method="POST" enctype="multipart/form-data">
        <label for="payment_file">Välj JSON-fil:</label>
        <input type="file" id="payment_file" name="payment_file" accept=".json" required>
        <input type="submit" value="Skicka">
      </form>
    </div>

    {% if error %}
    <div style="width: 100%; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; margin: 20px 0; border-radius: 5px;">
        <h2><b>Felmeddelande</b>:</h2>
        <hr>
        <p>{{ error }}</p>
    </div>
    {% endif %}

    {% if statistics %}
    <div style="width: 100%; background-color: #e7f3ff; border: 1px solid #b6d7ff; padding: 20px; margin: 20px 0; border-radius: 5px;">
        <h2><b>Matchningsstatistik</b></h2>
        <hr>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background-color: white; padding: 15px; border-radius: 5px; text-align: center;">
                <h3 style="color: #007bff; margin: 0;">{{ statistics.total }}</h3>
                <p style="margin: 5px 0;">Totala betalningar</p>
            </div>
            <div style="background-color: white; padding: 15px; border-radius: 5px; text-align: center;">
                <h3 style="color: #28a745; margin: 0;">{{ statistics.matched }}</h3>
                <p style="margin: 5px 0;">Matchade ({{ "%.1f"|format(statistics.matched_rate) }}%)</p>
            </div>
            <div style="background-color: white; padding: 15px; border-radius: 5px; text-align: center;">
                <h3 style="color: #17a2b8; margin: 0;">{{ statistics.perfect_matched }}</h3>
                <p style="margin: 5px 0;">Perfekt matchade ({{ "%.1f"|format(statistics.perfect_rate) }}%)</p>
            </div>
            <div style="background-color: white; padding: 15px; border-radius: 5px; text-align: center;">
                <h3 style="color: #fd7e14; margin: 0;">{{ statistics.relevant_matched }}</h3>
                <p style="margin: 5px 0;">Relevanta ({{ "%.1f"|format(statistics.relevant_rate) }}%)</p>
            </div>
            <div style="background-color: white; padding: 15px; border-radius: 5px; text-align: center;">
                <h3 style="color: #ffc107; margin: 0;">{{ statistics.paid_out }}</h3>
                <p style="margin: 5px 0;">Utbetalda ({{ "%.1f"|format(statistics.paid_out_rate) }}%)</p>
            </div>
            <div style="background-color: white; padding: 15px; border-radius: 5px; text-align: center;">
                <h3 style="color: #dc3545; margin: 0;">{{ statistics.unmatched }}</h3>
                <p style="margin: 5px 0;">Omatchade ({{ "%.1f"|format(statistics.unmatched_rate) }}%)</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if results %}
    <div style="width: 100%; margin: 20px 0;">
        <h2><b>Matchningsresultat</b> ({{ total_processed or results|length }} betalningar processade)</h2>
        <hr>
        {% for result in results %}
        <div style="background-color: #f5f5f5; padding: 20px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; width: 100%; box-sizing: border-box;">
            <h3><b>Betalning ID:</b> {{ result.id }}</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0;">
                <div>
                    <h4 style="color: #7A7A7A; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Betalningsinformation</h4>
                    <p><b>Referens:</b> {{ result.reference or 'Ingen' }}</p>
                    <p><b>Banknamn:</b> {{ result.bankName }}</p>
                    <p><b>Belopp:</b> {{ result.amount }}</p>
                    <p><b>Skapad:</b> {{ result.createdAt }}</p>
                    {% if result.info %}
                    <p><b>Information:</b></p>
                    <div style="background-color: white; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; max-height: 100px; overflow-y: auto;">
                        {{ result.info[:300] }}{% if result.info|length > 300 %}...{% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div>
                    <h4 style="color: #7A7A7A; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Matchningsinformation</h4>
                    <p><b>Matchade försäkringsfall:</b> {{ result.insuranceCaseId | join(', ') if result.insuranceCaseId else 'Inga' }}</p>
                    <p><b>Status:</b></p>
                    <div style="background-color: white; padding: 10px; border: 1px solid #ddd; border-radius: 3px; margin: 5px 0;">
                        {{ result.status | safe }}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if not results and not error %}
    <div class="result">
        <div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div>
    </div>
    {% endif %}
    
    <a href="/dashboard" class="back-button">⬅️ Dashboard</a> 
</body>
</html>